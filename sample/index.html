<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNO AI OCR Add Rows Demo</title>
</head>
<body>
    <!--
        Demo page for the JS library that automates adding and filling rows.
        Note: This library ships without a standalone CSS file.
        All required modal/loader styles are injected at runtime by ocr.js to avoid host CSS conflicts.
    -->
    <h1>Demo: Add Multiple Non-Stock Rows</h1>
    <p>This demo simulates adding rows to a purchase order form. The included JavaScript will automatically add and fill 10 rows on page load.</p>

    <div class="controls">
        <button type="button" id="ai-ocr-UploadBtn">OCR Upload</button>
    </div>

    <form id="poForm">
        <table id="rowsTable">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Brand</th>
                    <th>Short Desc</th>
                    <th>Long Desc</th>
                    <th>UOM</th>
                    <th>Qty</th>
                    <th>Unit List</th>
                    <th>Disc %</th>
                    <th>Unit Price</th>
                    <th>Amount</th>
                    <th>Unit w/GST</th>
                    <th>Conv</th>
                    <th>Qty UOM Stk</th>
                    <th>UPrice UOM Stk</th>
                    <th>UOM Stk</th>
                    <th>GST</th>
                    <th>Acct Disp</th>
                    <th>Dept Disp</th>
                    <th>Proj Disp</th>
                    <th>Rqt Day</th>
                    <th>Rqt Mth</th>
                    <th>Rqt Yr</th>
                    <th>Batch Num</th>
                </tr>
            </thead>
            <tbody>
                <!-- This initial row serves as a template for the script. -->
                <tr id="rowtr1">
                    <td><input name="stkcode_code1" type="text"></td>
                    <td><input name="stkcode_brand1" type="text"></td>
                    <td><input name="stkcode_desc1" type="text"></td>
                    <td><input name="desc1" type="text"></td>
                    <td><input name="uom_trans_code1_disp" type="text"></td>
                    <td><input name="qnty_total1" type="number"></td>
                    <td><input name="fmi_aup1_disp" type="number" step="0.01"></td>
                    <td><input name="discount_pct1" type="number" step="0.01"></td>
                    <td><input name="price_unitrate_forex1" type="number" step="0.01"></td>
                    <td><input name="extnamt_orig_forex1" type="number" step="0.01"></td>
                    <td><input name="uprice_wt_gst1" type="number" step="0.01"></td>
                    <td><input name="uom_trans_code1_conv" type="number"></td>
                    <td><input name="qnty_uomstk1" type="number"></td>
                    <td><input name="uprice_uomstk1" type="number" step="0.01"></td>
                    <td><input name="uomstk_code1" type="text"></td>
                    <td><input name="fmi_row_gst1" type="checkbox"></td>
                    <td><input name="fmi_row_acctnum1_disp" type="text"></td>
                    <td><input name="fmi_row_deptunit1_disp" type="text"></td>
                    <td><input name="fmi_row_entprojfn1_disp" type="text"></td>
                    <td><input name="rowday1" type="text"></td>
                    <td><input name="rowmth1" type="text"></td>
                    <td><input name="rowyear1" type="text"></td>
                    <td><input name="batchnum_code1" type="text"></td>
                </tr>
            </tbody>
        </table>
        <button type="button" id="gononstockbtn">Add Non-Stock Row</button>
        <input type="hidden" name="HddenMaxRowAdded" value="1">
    </form>

    <!-- OCR modal and loading overlay are now injected by ocr.js to reduce HTML markup -->

    <!--
        The inline script below provides a simple way to manually add new rows for testing.
        This is separate from the main automation script.
    -->
    <script>
        /**
         * This script handles the manual "Add Non-Stock Row" button clicks.
         * It adds a new, empty row to the table.
         */
        document.getElementById('gononstockbtn').addEventListener('click', function() {
            const hiddenInput = document.querySelector('input[name="HddenMaxRowAdded"]');
            let rowCount = hiddenInput ? parseInt(hiddenInput.value, 10) : 1;
            rowCount++;

            const tableBody = document.querySelector('#rowsTable tbody');
            const newRow = document.createElement('tr');
            newRow.id = `rowtr${rowCount}`;

            const columns = [
                'stkcode_code', 'stkcode_brand', 'stkcode_desc', 'desc', 'uom_trans_code_disp',
                'qnty_total', 'fmi_aup_disp', 'discount_pct', 'price_unitrate_forex', 'extnamt_orig_forex',
                'uprice_wt_gst', 'uom_trans_code_conv', 'qnty_uomstk', 'uprice_uomstk', 'uomstk_code',
                'fmi_row_gst', 'fmi_row_acctnum_disp', 'fmi_row_deptunit_disp', 'fmi_row_entprojfn_disp',
                'rowday', 'rowmth', 'rowyear', 'batchnum_code'
            ];

            newRow.innerHTML = columns.map(colName => {
                const name = `${colName}${rowCount}`;
                const inputType = colName.includes('gst') ? 'checkbox' : (colName.includes('qnty') || colName.includes('price') || colName.includes('amt')) ? 'number' : 'text';
                const stepAttr = (inputType === 'number') ? 'step="0.01"' : '';
                return `<td><input name="${name}" type="${inputType}" ${stepAttr}></td>`;
            }).join('');

            tableBody.appendChild(newRow);
            hiddenInput.value = rowCount;
        });
    </script>
    
    <!-- Single-entry loader (simple) -->
    <script src="folder_javascript/tno_ai_ocr_add_rows_loader.js?v=now"></script>

    <!--
      To avoid manually entering the API key in the prompt every time,
      you can set it here as a global JavaScript variable.
      The OCR script will automatically pick it up.
    -->
    <script>
      // Replace "YOUR_GEMINI_API_KEY_HERE" with your actual Gemini API key
      window.gemini_api_key = "YOUR_GEMINI_API_KEY_HERE";
    </script>

    <!-- This inline script generates and adds 10 sample rows on page load for demonstration. -->
    <script>
        // Wait until $addRows is available (loader autoloads core files on DOMContentLoaded with 'realtime' by default)
        async function waitForAddRows(timeoutMs = 10000) {
            const start = Date.now();
            while (Date.now() - start < timeoutMs) {
                if (typeof window.$addRows === 'function') return true;
                await new Promise(r => setTimeout(r, 50));
            }
            return false;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Ensure core scripts are ready before demo runs
            const ready = await waitForAddRows();
            if (!ready) {
                console.error('$addRows not available within timeout');
                return;
            }

            // A small, readable collection of sample products to make the demo data more realistic.
            const SAMPLE_PRODUCTS = [
                { brand: 'Logitech', desc: 'MX Master 3S Wireless Mouse', price: 169.00, uom: 'PC' },
                { brand: 'Dell', desc: 'UltraSharp U2723QE 27" 4K Monitor', price: 779.00, uom: 'UNIT' },
                { brand: 'Apple', desc: 'MacBook Pro 14" M3 Pro', price: 3299.00, uom: 'UNIT' },
                { brand: 'CalDigit', desc: 'TS4 Thunderbolt 4 Dock', price: 650.00, uom: 'PC' },
                { brand: 'Keychron', desc: 'Q1 Pro QMK/VIA Mechanical Keyboard', price: 315.00, uom: 'PC' }
            ];

            /**
             * Generates a complete, realistic sample row object based on a product definition.
             * @param {number} rowIndex - The index for the row (1-based).
             * @returns {object} The formatted row data object for the `$addRows` function.
             */
            const makeSampleRow = (rowIndex) => {
                // Select a product from the sample list, cycling through them for variety.
                const product = SAMPLE_PRODUCTS[(rowIndex - 1) % SAMPLE_PRODUCTS.length];

                // Minimal fields to match current TNO_SCHEMA
                const quantity = rowIndex % 3 + 1; // 1..3
                const unitPrice = product.price;    // demo uses list price as unit price

                return {
                    // Matches schema.js fields exactly
                    stkcode_code: `NS-${String(rowIndex).padStart(3, '0')}`,
                    stkcode_desc: product.desc,
                    desc: `Remark for ${product.desc} (Row ${rowIndex})`,
                    uom_trans_code: product.uom,
                    qnty_total: String(quantity),
                    price_unitrate_forex: unitPrice.toFixed(2)
                };
            };

            // On page load, generate and add 10 sample rows to the form.
            if (typeof window.$addRows === 'function') {
                const sampleRows = Array.from({ length: 10 }, (_, i) => makeSampleRow(i + 1));
                window.$addRows(sampleRows);
            } else {
                console.error('$addRows function not found. Ensure script.js is loaded correctly.');
            }
        });
    </script>
</body>
</html>